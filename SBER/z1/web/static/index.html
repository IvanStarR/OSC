<!doctype html>
<meta charset="utf-8">
<title>RPM Dependency Graph</title>
<style>
 body { font-family: system-ui, sans-serif; margin: 0; }
 header { padding: 10px 16px; background: #111; color: #fff; display:flex; gap:12px; align-items:center; }
 #search{ padding:6px 8px; width:320px; }
 #meta{ margin-left:auto; opacity:.8 }
 .tab{ cursor:pointer; padding:6px 10px; border-radius:6px; background:#222; }
 .tab.active{ background:#444; }
 svg { width: 100vw; height: calc(100vh - 52px); display:block; background:#f8f9fb; }
 .node circle { stroke:#333; stroke-width:.5px; }
 .node text { font-size: 11px; pointer-events:none; }
 .highlight circle { stroke:#e85; stroke-width:2px; }
</style>
<header>
  <span class="tab active" data-file="runtime_graph.json">Runtime</span>
  <span class="tab" data-file="build_graph.json">Build</span>
  <input id="search" placeholder="Найти пакет..." />
  <div id="meta"></div>
</header>
<svg></svg>
<script>
const svg = document.querySelector("svg");
const meta = document.getElementById("meta");
const tabs = document.querySelectorAll(".tab");
const search = document.getElementById("search");
let data, sim, nodesSel, linksSel, id2node;

async function loadGraph(file){
  const res = await fetch(file);
  data = await res.json();
  meta.textContent = `${data.title} • nodes: ${data.meta.node_count} • edges: ${data.meta.edge_count}`;
  draw();
}

function draw(){
  svg.innerHTML = "";
  id2node = Object.fromEntries(data.nodes.map(n=>[n.id,n]));
  const width = svg.clientWidth, height = svg.clientHeight;
  const g = d3.select(svg).append("g");
  linksSel = g.selectAll(".link").data(data.links).enter()
    .append("line").attr("class","link").attr("stroke","#aaa").attr("stroke-opacity",.6);
  nodesSel = g.selectAll(".node").data(data.nodes, d=>d.id).enter()
    .append("g").attr("class","node").call(drag(sim));
  nodesSel.append("circle")
    .attr("r", d => d.kind==="srpm" ? 7 : 5)
    .attr("fill", d => d.kind==="srpm" ? "#8fb" : "#9bd");
  nodesSel.append("title").text(d=>d.id);
  nodesSel.append("text").attr("dx",8).attr("dy",".31em").text(d=>d.id);

  sim = d3.forceSimulation(data.nodes)
    .force("link", d3.forceLink(data.links).id(d=>d.id).distance(40).strength(.2))
    .force("charge", d3.forceManyBody().strength(-40))
    .force("center", d3.forceCenter(width/2, height/2))
    .on("tick", ()=>{
      linksSel
        .attr("x1", d=>d.source.x).attr("y1", d=>d.source.y)
        .attr("x2", d=>d.target.x).attr("y2", d=>d.target.y);
      nodesSel.attr("transform", d=>`translate(${d.x},${d.y})`);
    });
}

function drag(sim){
  function dragstarted(event,d){ if(!event.active) sim.alphaTarget(0.3).restart(); d.fx=d.x; d.fy=d.y; }
  function dragged(event,d){ d.fx=event.x; d.fy=event.y; }
  function dragended(event,d){ if(!event.active) sim.alphaTarget(0); d.fx=null; d.fy=null; }
  return d3.drag().on("start",dragstarted).on("drag",dragged).on("end",dragended);
}

function highlight(q){
  q = q.trim().toLowerCase();
  d3.selectAll(".node").classed("highlight", d => q && d.id.toLowerCase().includes(q));
}

tabs.forEach(t=>t.onclick = ()=>{
  tabs.forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  loadGraph(t.dataset.file);
});

search.addEventListener("input", e=> highlight(e.target.value));

const s = document.createElement("script");
s.src="https://d3js.org/d3.v7.min.js";
s.onload=()=>loadGraph("runtime_graph.json");
document.body.appendChild(s);
</script>
